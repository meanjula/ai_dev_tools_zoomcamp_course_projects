{
  "openapi": "3.0.3",
  "info": {
    "title": "Code Explainer (Ollama-backed)",
    "version": "1.0.0",
    "description": "API that accepts source code and returns an explanation streamed from a local Ollama model. The server proxies requests to Ollama and streams NDJSON tokens back to the client."
  },
  "servers": [
    {
      "url": "http://localhost:3001",
      "description": "Local API gateway (this server proxies to Ollama)"
    }
  ],
  "paths": {
    "/": {
      "get": {
        "summary": "Health check",
        "responses": {
          "200": {
            "description": "Server is running",
            "content": {
              "text/plain": {
                "schema": { "type": "string" },
                "example": "Server is running!"
              }
            }
          }
        }
      }
    },
    "/api/explain-code": {
      "post": {
        "tags": ["Explainer"],
        "operationId": "explainCode",
        "summary": "Explain code via Ollama",
        "description": "Send code and language; the server forwards the request to the local Ollama/OpenAI-compatible runtime and streams the explanation back as NDJSON lines.",
        "security": [{ "BearerAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ExplainRequest" },
              "example": {
                "code": "def add(a, b):\n  return a + b",
                "language": "python",
                "chatId": "<optional-chat-id>",
                "userId": "<optional-user-id>"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Streaming NDJSON (application/x-ndjson) - each line is a JSON object (token/done/error)",
            "content": {
              "application/x-ndjson": {
                "schema": { "type": "string" },
                "examples": {
                  "stream": {
                    "summary": "NDJSON stream example",
                    "value": "{\"type\":\"token\",\"content\":\"Explain the function...\"}\\n{\"type\":\"done\",\"content\":\"Full explanation text\"}\\n"
                  }
                }
              }
            }
          },
          "400": {
            "description": "Bad request (missing fields)",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } }
          },
          "500": {
            "description": "Server or Ollama error",
            "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } }
          }
        }
      }
    }
    ,
    "/api/register": {
      "post": {
        "tags": ["Auth"],
        "summary": "Register a user (create if missing)",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "name": { "type": "string" },
                  "email": { "type": "string", "format": "email" }
                },
                "required": ["email"]
              },
              "example": { "name": "Alice", "email": "alice@example.com" }
            }
          }
        },
        "responses": {
          "201": { "description": "Created", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" }, "example": { "id": "00000000-0000-0000-0000-000000000001", "name": "Alice", "email": "alice@example.com" } } } },
          "200": { "description": "Already exists", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" }, "example": { "id": "00000000-0000-0000-0000-000000000001", "name": "Alice", "email": "alice@example.com" } } } },
          "400": { "description": "Bad request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/api/login": {
      "post": {
        "tags": ["Auth"],
        "summary": "Login by email (no password) - returns user if found",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": { "email": { "type": "string", "format": "email" } },
                "required": ["email"]
              }
            }
          }
          ,
          "example": { "email": "alice@example.com" }
        },
        "responses": {
          "200": { "description": "OK", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/User" }, "example": { "id": "00000000-0000-0000-0000-000000000001", "name": "Alice", "email": "alice@example.com" } } } },
          "404": { "description": "Not found", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" }, "example": { "error": "not_found" } } } }
        }
      }
    },
    "/api/chats": {
      "get": {
        "tags": ["Chats"],
        "summary": "List chats for authenticated user",
        "security": [{ "BearerAuth": [] }],
        "responses": {
          "200": { "description": "List of chats", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Chat" } }, "example": [ { "id": "11111111-1111-1111-1111-111111111111", "user_id": "00000000-0000-0000-0000-000000000001", "title": "Code explanation", "created_at": "2026-01-27T12:00:00Z" } ] } } },
          "401": { "description": "Unauthorized", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    },
    "/api/chats/{chatId}/messages": {
      "get": {
        "tags": ["Chats"],
        "summary": "Get messages for a chat",
        "security": [{ "BearerAuth": [] }],
        "parameters": [
          { "name": "chatId", "in": "path", "required": true, "schema": { "type": "string" } }
        ],
        "responses": {
          "200": { "description": "List of messages", "content": { "application/json": { "schema": { "type": "array", "items": { "$ref": "#/components/schemas/Message" } }, "example": [ { "id": "22222222-2222-2222-2222-222222222222", "chat_id": "11111111-1111-1111-1111-111111111111", "role": "user", "content": "Please explain this function", "code": "def add(a,b): return a+b", "language": "python", "created_at": "2026-01-27T12:00:00Z" }, { "id": "33333333-3333-3333-3333-333333333333", "chat_id": "11111111-1111-1111-1111-111111111111", "role": "assistant", "content": "This function adds two numbers.", "created_at": "2026-01-27T12:00:05Z" } ] } } },
          "401": { "description": "Unauthorized", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ErrorResponse" } } } }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "UUID-or-token"
      }
    },
    "schemas": {
      "ExplainRequest": {
        "type": "object",
        "required": ["code", "language"],
        "properties": {
          "code": { "type": "string", "description": "Source code to explain" },
          "language": { "type": "string", "description": "Programming language (e.g., javascript, python)" },
          "model": { "type": "string", "description": "Optional Ollama model name (overrides server default). Example: llama3" },
          "userId": { "type": "string", "format": "uuid", "description": "Optional: user id (if not provided, Authorization header is required)" },
          "chatId": { "type": "string", "format": "uuid", "description": "Optional: existing chat id to reuse as context" }
        }
      },
      
      "TokenMessage": {
        "type": "object",
        "properties": {
          "type": { "type": "string", "enum": ["token"] },
          "content": { "type": "string" }
        }
      },
      "DoneMessage": {
        "type": "object",
        "properties": {
          "type": { "type": "string", "enum": ["done"] },
          "content": { "type": "string" }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": { "type": "string" }
        }
      }
      ,
      "User": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "name": { "type": "string" },
          "email": { "type": "string", "format": "email" }
        }
      },
      "Chat": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "user_id": { "type": "string", "format": "uuid" },
          "title": { "type": "string" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      },
      "Message": {
        "type": "object",
        "properties": {
          "id": { "type": "string", "format": "uuid" },
          "chat_id": { "type": "string", "format": "uuid" },
          "role": { "type": "string" },
          "content": { "type": "string" },
          "code": { "type": "string" },
          "language": { "type": "string" },
          "created_at": { "type": "string", "format": "date-time" }
        }
      }
    }
  },
  
  "tags": [
    { "name": "Explainer", "description": "Code explanation endpoints that proxy to the local Ollama runtime" },
    { "name": "Auth", "description": "Registration and login endpoints" },
    { "name": "Chats", "description": "Chat and message retrieval endpoints" }
  ],
  "x-ollama": {
    "description": "Vendor extension describing the Ollama runtime used by the API",
    "host": "http://localhost:11434",
    "models": ["llama3"],
    "notes": "This API proxies requests to a local Ollama instance (or OpenAI-compatible server). The client should call this server's /api/explain-code endpoint; streaming is performed as NDJSON lines."
  }
}
